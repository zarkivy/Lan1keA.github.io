<!DOCTYPE html>
<html lang="" dir="ltr">
    <head><meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'><meta name='description' content='ä»¥åŠCVE-2022-30552'><title>å¯¹U-Boot CVE-2022-30790çš„è·Ÿè¸ª</title>

<link rel='canonical' href='https://cerr.cc/post/%E5%AF%B9u-boot-cve-2022-30790%E7%9A%84%E8%B7%9F%E8%B8%AA/'>

<link rel="stylesheet" href="/scss/style.min.e75bab105855f77caa94de85bd0b7a889920eb03fa3048257f51f59c063a674d.css"><meta property='og:title' content='å¯¹U-Boot CVE-2022-30790çš„è·Ÿè¸ª'>
<meta property='og:description' content='ä»¥åŠCVE-2022-30552'>
<meta property='og:url' content='https://cerr.cc/post/%E5%AF%B9u-boot-cve-2022-30790%E7%9A%84%E8%B7%9F%E8%B8%AA/'>
<meta property='og:site_name' content='Zikey Vi'>
<meta property='og:type' content='article'><meta property='article:section' content='Post' /><meta property='article:tag' content='Coreutils' /><meta property='article:published_time' content='2022-06-16T10:11:14&#43;08:00'/><meta property='article:modified_time' content='2022-06-16T10:11:14&#43;08:00'/><meta property='og:image' content='https://s2.loli.net/2022/06/16/R9KWInUb6Cdyhl2.jpg' />
<meta name="twitter:title" content="å¯¹U-Boot CVE-2022-30790çš„è·Ÿè¸ª">
<meta name="twitter:description" content="ä»¥åŠCVE-2022-30552"><meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:image" content='https://s2.loli.net/2022/06/16/R9KWInUb6Cdyhl2.jpg' />
    <link rel="shortcut icon" href="favicon.png" />

    </head>
    <body class="
    article-page
    ">
    <script>
        (function() {
            const colorSchemeKey = 'StackColorScheme';
            if(!localStorage.getItem(colorSchemeKey)){
                localStorage.setItem(colorSchemeKey, "auto");
            }
        })();
    </script><script>
    (function() {
        const colorSchemeKey = 'StackColorScheme';
        const colorSchemeItem = localStorage.getItem(colorSchemeKey);
        const supportDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches === true;

        if (colorSchemeItem == 'dark' || colorSchemeItem === 'auto' && supportDarkMode) {
            

            document.documentElement.dataset.scheme = 'dark';
        } else {
            document.documentElement.dataset.scheme = 'light';
        }
    })();
</script>
<div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky ">
    <button class="hamburger hamburger--spin" type="button" id="toggle-menu" aria-label="Toggle Menu">
        <span class="hamburger-box">
            <span class="hamburger-inner"></span>
        </span>
    </button>

    <header>
        
            
            <figure class="site-avatar">
                <a href="/">
                
                    
                    
                    
                        
                        <img src="/img/avatar_hu83ce41192ed66b608a10477eb7108e0c_128714_300x0_resize_q75_box.jpg" width="300"
                            height="300" class="site-logo" loading="lazy" alt="Avatar">
                    
                
                </a>
                
                    <span class="emoji">ğŸŸ</span>
                
            </figure>
            
        
        
        <div class="site-meta">
            <h1 class="site-name"><a href="/">Zikey Vi</a></h1>
            <h2 class="site-description">Yet anothor cyber nyandog.</h2>
        </div>
    </header><ol class="social-menu">
            
                <li>
                    <a 
                        href='https://github.com/dev2ero'
                        target="_blank"
                        title="GitHub"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M9 19c-4.3 1.4 -4.3 -2.5 -6 -3m12 5v-3.5c0 -1 .1 -1.4 -.5 -2c2.8 -.3 5.5 -1.4 5.5 -6a4.6 4.6 0 0 0 -1.3 -3.2a4.2 4.2 0 0 0 -.1 -3.2s-1.1 -.3 -3.5 1.3a12.3 12.3 0 0 0 -6.2 0c-2.4 -1.6 -3.5 -1.3 -3.5 -1.3a4.2 4.2 0 0 0 -.1 3.2a4.6 4.6 0 0 0 -1.3 3.2c0 4.6 2.7 5.7 5.5 6c-.6 .6 -.6 1.2 -.5 2v3.5" />
</svg>



                        
                    </a>
                </li>
            
                <li>
                    <a 
                        href='mailto:dev2ero@foxmail.com'
                        target="_blank"
                        title="Mail"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-mail-opened" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <polyline points="3 9 12 15 21 9 12 3 3 9" />
  <path d="M21 9v10a2 2 0 0 1 -2 2h-14a2 2 0 0 1 -2 -2v-10" />
  <line x1="3" y1="19" x2="9" y2="13" />
  <line x1="15" y1="13" x2="21" y2="19" />
</svg>

                        
                    </a>
                </li>
            
                <li>
                    <a 
                        href='https://twitter.com/dev2ero'
                        target="_blank"
                        title="Twitter"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-twitter" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M22 4.01c-1 .49 -1.98 .689 -3 .99c-1.121 -1.265 -2.783 -1.335 -4.38 -.737s-2.643 2.06 -2.62 3.737v1c-3.245 .083 -6.135 -1.395 -8 -4c0 0 -4.182 7.433 4 11c-1.872 1.247 -3.739 2.088 -6 2c3.308 1.803 6.913 2.423 10.034 1.517c3.58 -1.04 6.522 -3.723 7.651 -7.742a13.84 13.84 0 0 0 .497 -3.753c-.002 -.249 1.51 -2.772 1.818 -4.013z" />
</svg>



                        
                    </a>
                </li>
            
        </ol><ol class="menu" id="main-menu">
        
        
        

        <li >
            <a href='/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <polyline points="5 12 3 12 12 3 21 12 19 12" />
  <path d="M5 12v7a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-7" />
  <path d="M9 21v-6a2 2 0 0 1 2 -2h2a2 2 0 0 1 2 2v6" />
</svg>



                
                <span>Home</span>
            </a>
        </li>
        
        

        <li >
            <a href='/archives/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <rect x="3" y="4" width="18" height="4" rx="2" />
  <path d="M5 8v10a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-10" />
  <line x1="10" y1="12" x2="14" y2="12" />
</svg>



                
                <span>Archive</span>
            </a>
        </li>
        
        

        <li >
            <a href='/about/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="7" r="4" />
  <path d="M6 21v-2a4 4 0 0 1 4 -4h4a4 4 0 0 1 4 4v2" />
</svg>



                
                <span>About</span>
            </a>
        </li>
        
        

        <li >
            <a href='/love/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-heart" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M19.5 13.572l-7.5 7.428l-7.5 -7.428m0 0a5 5 0 1 1 7.5 -6.566a5 5 0 1 1 7.5 6.572" />
</svg>

                
                <span>Love</span>
            </a>
        </li>
        
        

        <li >
            <a href='/friends/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-friends" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <circle cx="7" cy="5" r="2" />
  <path d="M5 22v-5l-1 -1v-4a1 1 0 0 1 1 -1h4a1 1 0 0 1 1 1v4l-1 1v5" />
  <circle cx="17" cy="5" r="2" />
  <path d="M15 22v-4h-2l2 -6a1 1 0 0 1 1 -1h2a1 1 0 0 1 1 1l2 6h-2v4" />
</svg>

                
                <span>Friends</span>
            </a>
        </li>
        
        

        <li >
            <a href='/utils/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M10 14a3.5 3.5 0 0 0 5 0l4 -4a3.5 3.5 0 0 0 -5 -5l-.5 .5" />
  <path d="M14 10a3.5 3.5 0 0 0 -5 0l-4 4a3.5 3.5 0 0 0 5 5l.5 -.5" />
</svg>



                
                <span>Utils</span>
            </a>
        </li>
        
        

        <li >
            <a href='/board/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copy" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <rect x="8" y="8" width="12" height="12" rx="2" />
  <path d="M16 8v-2a2 2 0 0 0 -2 -2h-8a2 2 0 0 0 -2 2v8a2 2 0 0 0 2 2h2" />
</svg>

                
                <span>Board</span>
            </a>
        </li>
        
        

        <li >
            <a href='/search/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="10" cy="10" r="7" />
  <line x1="21" y1="21" x2="15" y2="15" />
</svg>



                
                <span>Search</span>
            </a>
        </li>
        

        <div class="menu-bottom-section">
            
            
                <li id="dark-mode-toggle">
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="8" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="16" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                    <span>Dark Mode</span>
                </li>
            
        </div>
    </ol>
</aside>
<main class="main full-width">
    <article class="has-image main-article">
    <header class="article-header">
        <div class="article-image">
            <a href="/post/%E5%AF%B9u-boot-cve-2022-30790%E7%9A%84%E8%B7%9F%E8%B8%AA/">
                
                    <img src="https://s2.loli.net/2022/06/16/R9KWInUb6Cdyhl2.jpg" loading="lazy" alt="Featured image of post å¯¹U-Boot CVE-2022-30790çš„è·Ÿè¸ª" />
                
            </a>
        </div>
    

    <div class="article-details">
    
    <header class="article-category">
        
            <a href="/categories/%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/" >
                æ¼æ´åˆ†æ
            </a>
        
    </header>
    

    <div class="article-title-wrapper">
        <h2 class="article-title">
            <a href="/post/%E5%AF%B9u-boot-cve-2022-30790%E7%9A%84%E8%B7%9F%E8%B8%AA/">å¯¹U-Boot CVE-2022-30790çš„è·Ÿè¸ª</a>
        </h2>
    
        
        <h3 class="article-subtitle">
            ä»¥åŠCVE-2022-30552
        </h3>
        
    </div>

    
    <footer class="article-time">
        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M11.795 21h-6.795a2 2 0 0 1 -2 -2v-12a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v4" />
  <circle cx="18" cy="18" r="4" />
  <path d="M15 3v4" />
  <path d="M7 3v4" />
  <path d="M3 11h16" />
  <path d="M18 16.496v1.504l1 1" />
</svg>
                <time class="article-time--published">Jun 16, 2022</time>
            </div>
        

        
    </footer>
    

    
</div>
</header>

    <section class="article-content">
    
    
    <h1 id="u-booté€Ÿè§ˆ">U-Booté€Ÿè§ˆ</h1>
<ul>
<li><a class="link" href="https://en.wikipedia.org/wiki/Das_U-Boot"  target="_blank" rel="noopener"
    >Das U-Boot - Wikipedia</a></li>
<li><a class="link" href="https://github.com/u-boot/u-boot"  target="_blank" rel="noopener"
    >https://github.com/u-boot/u-boot</a></li>
<li><a class="link" href="https://elixir.bootlin.com/u-boot/latest/source"  target="_blank" rel="noopener"
    >U-Bootæºç åœ¨çº¿æµè§ˆ</a></li>
</ul>
<h1 id="æ‘ä¸­ä¼ è¨€">æ‘ä¸­ä¼ è¨€</h1>
<p><strong><a class="link" href="https://research.nccgroup.com/2022/06/03/technical-advisory-multiple-vulnerabilities-in-u-boot-cve-2022-30790-cve-2022-30552/"  target="_blank" rel="noopener"
    >https://research.nccgroup.com/2022/06/03/technical-advisory-multiple-vulnerabilities-in-u-boot-cve-2022-30790-cve-2022-30552/</a></strong></p>
<p>ğŸ¤”Hmmm&hellip;æ–°é²œæ¼æ´ï¼Œæ²¡æœ‰PoCã€‚è¿™æ¬¡æ˜¯å‡ºäº†ä¸¤ä¸ªæ¼æ´ï¼Œåˆ†åˆ«æ˜¯ï¼š</p>
<ul>
<li>Hole Descriptor Overwrite in U-Boot IP Packet Defragmentation Leads to Arbitrary Out of Bounds Write Primitive (<a class="link" href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2022-30790"  target="_blank" rel="noopener"
    >CVE-2022-30790</a>)</li>
<li>Large buffer overflow leads to DoS in U-Boot IP Packet Defragmentation Code (<a class="link" href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2022-30552"  target="_blank" rel="noopener"
    >CVE-2022-30552</a>)</li>
</ul>
<p>å…ˆæ¥åˆ†æåˆ†æå‡ºç°æ¼æ´çš„æºç ã€‚æ ¹æ®ï¼š</p>
<blockquote>
<p><strong>May 18th 2022:</strong> Initial e-mail from NCC to U-boot maintainers announcing two vulnerabilities were identified.</p>
</blockquote>
<p>é‚£ä¹ˆç”¨U-Boot v2022.04è·Ÿè¸ªæ¼æ´åº”è¯¥æ˜¯æ²¡æœ‰é—®é¢˜çš„ã€‚</p>
<h1 id="æ¼æ´æºç åˆ†æ">æ¼æ´æºç åˆ†æ</h1>
<h2 id="cve-2022-30790">CVE-2022-30790</h2>
<p>æ¼æ´å½±å“ï¼š</p>
<blockquote>
<p>The U-Boot implementation of <a class="link" href="https://datatracker.ietf.org/doc/html/rfc815"  target="_blank" rel="noopener"
    >RFC815</a> IP DATAGRAM REASSEMBLY ALGORITHMS is susceptible to a Hole Descriptor overwrite attack which ultimately leads to an arbitrary write primitive.</p>
</blockquote>
<h3 id="rfc815">RFC815</h3>
<p>çœ‹æ¥éœ€è¦å…ˆäº†è§£ä¸‹RFC815çš„IPv4åˆ†ç‰‡ç®—æ³•ï¼š</p>
<ul>
<li>åŸæ–‡æ¡£ï¼š<a class="link" href="https://datatracker.ietf.org/doc/html/rfc815"  target="_blank" rel="noopener"
    >https://datatracker.ietf.org/doc/html/rfc815</a></li>
<li>ä¸€ç¯‡ç›¸å…³è®ºæ–‡ï¼š<a class="link" href="http://www.ecice06.com/CN/Y2008/V34/I22/100"  target="_blank" rel="noopener"
    >http://www.ecice06.com/CN/Y2008/V34/I22/100</a></li>
</ul>
<blockquote>
<p>RFC815 æ˜¯ IETF æ¨èçš„ä¸€ç§åˆ†ç‰‡é‡ç»„ç®—æ³•ï¼Œè¯¥ç®—æ³•å…·æœ‰è®°å½•åˆ†ç‰‡ç®€æ´ï¼Œå†…å­˜éœ€æ±‚é‡ä¸åŸ IPv4 æ•°æ®æŠ¥å¤§å°ä¸€è‡´ç­‰ä¼˜ç‚¹ã€‚</p>
</blockquote>
<p>è¯¥ç®—æ³•çš„ä½œç”¨å¯¹è±¡æ˜¯IPv4æ•°æ®æŠ¥ã€‚IPv4æ•°æ®æŠ¥çš„Headerç»“æ„å¦‚ä¸‹ï¼š(ref - <a class="link" href="https://en.wikipedia.org/wiki/IPv4"  target="_blank" rel="noopener"
    >https://en.wikipedia.org/wiki/IPv4</a></p>
<p><img src="https://s2.loli.net/2022/06/16/nlCgH1URZ7uXwQ3.png"
	
	
	
	loading="lazy"
	
		alt="image.png"
	
	
></p>
<p>å…¶ä¸­ï¼Œåˆ†ç‰‡ä¿¡æ¯è®°å½•åœ¨ï¼š</p>
<ul>
<li>
<p><strong>Identification</strong></p>
<ul>
<li>This field is an identification field and is primarily used for uniquely identifying the group of fragments of a single IP datagram. Some experimental work has suggested using the ID field for other purposes, such as for adding packet-tracing information to help trace datagrams with spoofed source addresses, but RFC 6864 now prohibits any such use.</li>
</ul>
</li>
<li>
<p><strong>Flags</strong></p>
<ul>
<li>
<p>A three-bit field follows and is used to control or identify fragments. They are (in order, from most significant to least significant):</p>
<ul>
<li>bit 0: Reserved; must be zero</li>
<li>bit 1: Don&rsquo;t Fragment (DF)</li>
<li>bit 2: More Fragments (MF)</li>
</ul>
<p>If the DF flag is set, and fragmentation is required to route the packet, then the packet is dropped. This can be used when sending packets to a host that does not have resources to perform reassembly of fragments. It can also be used for <a class="link" href="https://en.wikipedia.org/wiki/Path_MTU_discovery"  target="_blank" rel="noopener"
    >path MTU discovery</a>, either automatically by the host IP software, or manually using diagnostic tools such as <a class="link" href="https://en.wikipedia.org/wiki/Ping_%28networking_utility%29"  target="_blank" rel="noopener"
    >ping</a> or <a class="link" href="https://en.wikipedia.org/wiki/Traceroute"  target="_blank" rel="noopener"
    >traceroute</a>.</p>
<p>For unfragmented packets, the MF flag is cleared. For fragmented packets, all fragments except the last have the MF flag set. The last fragment has a non-zero Fragment Offset field, differentiating it from an unfragmented packet.</p>
</li>
</ul>
</li>
<li>
<p><strong>Fragment Offset</strong></p>
<ul>
<li>This field specifies the offset of a particular fragment relative to the beginning of the original unfragmented IP datagram <strong>in units of eight-byte blocks</strong>. The first fragment has an offset of zero. The 13 bit field allows a maximum offset of (2<sup>13</sup> â€“ 1) Ã— 8 = 65,528 bytes, which, with the header length included (65,528 + 20 = 65,548 bytes), supports fragmentation of packets exceeding the maximum IP length of 65,535 bytes.</li>
</ul>
</li>
</ul>
<p>æ³¨æ„åˆ°åˆ†ç‰‡çš„ç´¢å¼•å•ä½ä¸º8å­—èŠ‚ã€‚</p>
<p>å¥½äº†ï¼Œç®€å•äº†è§£è¿‡æ•°æ®ç»“æ„ï¼Œæ¥ç€æ¥çœ‹çœ‹ç®—æ³•ã€‚</p>
<p>åŸæ–‡æ¡£æœ‰è¨€ï¼š</p>
<blockquote>
<p>One of the mechanisms of IP is fragmentation and reassembly.</p>
<p>åˆ†ç‰‡å’Œé‡ç»„æ˜¯IPv4åè®®çš„ä¸€ä¸ªæœºåˆ¶ã€‚(æ–‡æ¡£å¾ˆè€ï¼Œé‚£æ—¶è¿˜æ²¡æœ‰IPv6ã€‚In contrast, <a class="link" href="https://en.wikipedia.org/wiki/IPv6"  target="_blank" rel="noopener"
    >IPv6</a>, the next generation of the Internet Protocol, does not allow routers to perform fragmentation; hosts must perform <a class="link" href="https://en.wikipedia.org/wiki/Path_MTU_Discovery"  target="_blank" rel="noopener"
    >Path MTU Discovery</a> before sending datagrams.)</p>
</blockquote>
<blockquote>
<p>A  datagram originally transmitted as a single unit will arrive at its final destination broken into several fragments.</p>
<p>ä¸€ä¸ªæ•°æ®æŠ¥â€”â€”ä½œä¸ºä¼ è¾“åŸºæœ¬å•å…ƒï¼Œä¼šè¢«åˆ‡åˆ†ä¸ºå¤šä¸ªåˆ†ç‰‡é€è¾¾æœ€ç»ˆçš„ç›®çš„åœ°ã€‚</p>
</blockquote>
<p>è€ŒRFC815æ‰€å®šä¹‰çš„ï¼Œæ­£æ˜¯<strong>reassemblyâ€”â€”åˆ†ç‰‡é‡ç»„</strong>è¿™ä¸€æ­¥çš„å…·ä½“å®ç°ç®—æ³•ã€‚</p>
<blockquote>
<p>In  order  to  define this reassembly algorithm, it is necessary to define some terms.</p>
<p>A partially reassembled datagram consists of certain sequences of octets that have already arrived, and certain  areas  still to  come.</p>
</blockquote>
<blockquote>
<p>We will refer to these missing areas as <strong>&ldquo;holes&rdquo;</strong>.</p>
<p>Each hole can be characterized by two numbers:</p>
<ul>
<li><strong>hole.first</strong>
<ul>
<li>the number of the first octet in the hole</li>
</ul>
</li>
<li><strong>hole.last</strong>
<ul>
<li>the number of the last  octet  in  the hole</li>
</ul>
</li>
</ul>
<p>This pair of numbers we will call the <strong>&ldquo;hole descriptor&rdquo;</strong>,</p>
<p>and we will assume that all of the hole descriptors for a  particular  datagram are gathered together in the <strong>&ldquo;hole descriptor list&rdquo;</strong>.</p>
</blockquote>
<p>æ€»ä½“æ¥è¯´:</p>
<blockquote>
<p>The  general  form  of  the  algorithm  is  as follows.</p>
<p>When a new fragment of the datagram arrives, it will possibly fill in one  or  more of  the existing holes.</p>
<p>We will examine each of the entries in the hole descriptor list to see whether the hole in  question  is  eliminated  by this incoming fragment.</p>
<p>If so, we will delete that entry from the list.</p>
<p>Eventually, a fragment will arrive which eliminates every entry from the list.</p>
<p>At this point, the datagram has been completely reassembled and can be passed to higher protocol levels for further processing.</p>
</blockquote>
<p>å…·ä½“çš„ç®—æ³•å®ç°è¦åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼š</p>
<p>é¦–å…ˆæ˜¯<strong>Fragment Processing Algorithm</strong></p>
<blockquote>
<p>We  start  the algorithm when the earliest fragment of the datagram arrives.  We begin by creating an empty data buffer area and putting one entry in its  hole  descriptor  list,  the  entry  which  describes  the datagram  as  being completely missing.  In this case, hole.first equals zero, and hole.last equals infinity. (Infinity is presumably implemented by a very large integer, greater than 576, of the implementor&rsquo;s choice.) The following eight steps are then used to insert each of  the  arriving fragments  into  the  buffer  area  where the complete datagram is being built up.  The arriving fragment is  described  by  fragment.first,  the first  octet  of  the fragment, and fragment.last, the last octet of the fragment.</p>
</blockquote>
<p>æ¥ç€è¿›è¡Œå¦‚ä¸‹æµç¨‹ï¼š</p>
<ol>
<li>Select the next hole  descriptor  from  the  hole  descriptor list.  If there are no more entries, go to step eight.</li>
<li>If fragment.first is greater than hole.last, go to step one.</li>
<li>If fragment.last is less than hole.first, go to step one.</li>
<li>Delete the current entry from the hole descriptor list.</li>
<li>If fragment.first is greater than hole.first, then  create  a new  hole  descriptor &ldquo;new_hole&rdquo; with new_hole.first equal to hole.first, and new_hole.last equal to  fragment.first  minus one.</li>
<li>If fragment.last is less  than  hole.last  and  fragment.more fragments   is  true,  then  create  a  new  hole  descriptor &ldquo;new_hole&rdquo;, with new_hole.first equal to  fragment.last  plus one and new_hole.last equal to hole.last.</li>
<li>Go to step one.</li>
<li>If the hole descriptor list is now empty, the datagram is now complete.  Pass it on to the higher level protocol  processor for further handling. Otherwise, return.</li>
</ol>
<p>ç®—æ³•çš„ç¬¬äºŒéƒ¨åˆ†æ˜¯<strong>Managing the Hole Descriptor List</strong></p>
<p>å…¶ä¸­æœ‰è§„åˆ™ï¼š</p>
<blockquote>
<p>Just put each hole descriptor in the first octets of  the  hole  itself.</p>
<p>å°†holeçš„æè¿°ç¬¦ç½®äºholeçš„å‰å…«ä¸ªå­—èŠ‚ä½ç½®å³å¯ã€‚</p>
<p>Note  that by the definition of the reassembly algorithm, the minimum size of  a  hole  is  eight  octets.</p>
<p>To  store hole.first  and  hole.last  will presumably require two octets each.</p>
<p>An additional two octets will be required to thread together the entries on the hole descriptor list.</p>
<p>This leaves at least two more octets to  dealwith implementation idiosyncrasies.</p>
</blockquote>
<p>holeçš„æœ€å°å¤§å°æ˜¯8å­—èŠ‚ã€‚å¤§å°å’ŒU-Bootçš„å®ç°æ˜¯å¥‘åˆçš„ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm"> * this is the packet being assembled, either data or frag control.
</span></span></span><span class="line"><span class="cl"><span class="cm"> * Fragments go by 8 bytes, so this union must be 8 bytes long
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="k">struct</span> <span class="n">hole</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="cm">/* first_byte is address of this structure */</span>
</span></span><span class="line"><span class="cl">	<span class="n">u16</span> <span class="n">last_byte</span><span class="p">;</span>	<span class="cm">/* last byte in this hole + 1 (begin of next hole) */</span>
</span></span><span class="line"><span class="cl">	<span class="n">u16</span> <span class="n">next_hole</span><span class="p">;</span>	<span class="cm">/* index of next (in 8-b blocks), 0 == none */</span>
</span></span><span class="line"><span class="cl">	<span class="n">u16</span> <span class="n">prev_hole</span><span class="p">;</span>	<span class="cm">/* index of prev, 0 == none */</span>
</span></span><span class="line"><span class="cl">	<span class="n">u16</span> <span class="n">unused</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ä½†å†…å®¹æœ‰äº›ä¸åŒï¼šU-Bootçš„å®ç°å¹¶ä¸åŒ…å«<code>hole.first</code>åŸŸï¼Œå› ä¸º first_byte is address of this structure.</p>
<p>ç”±æ­¤çœ‹æ¥ï¼Œè¿™é‡Œçš„å†…å­˜ç®¡ç†æ–¹å¼ç±»ä¼¼äºGlibcå †å†…å­˜ç®¡ç†æ–¹æ¡ˆã€‚ç”¨åŒå‘é“¾è¡¨ç®¡ç†äº†ç©ºé—²åŒºåŸŸï¼ˆholeã€free chunkï¼‰ï¼Œä¸”åœ¨ç©ºé—²åŒºåŸŸå†…éƒ¨è®°å½•è‡ªå·±çš„ç›¸å…³ä¿¡æ¯ï¼Œæœ€å°å¤§å°ä¸ºè‡ªèº«æ§åˆ¶åŸŸï¼ˆ8-Bytes struct holeã€free chunk headerï¼‰ï¼Œå¹¶ç»„æˆåŒå‘é“¾è¡¨ç”¨äºé«˜æ•ˆæ£€ç´¢ã€‚ä½†ä¸€ä¸ªåŒºåˆ«æ˜¯ï¼Œholeä¹‹é—´ç»„æˆçš„é“¾è¡¨ï¼Œæ˜¯å€Ÿç”±å­—èŠ‚ç´¢å¼•è€ŒéæŒ‡é’ˆå®ç°çš„ã€‚</p>
<h3 id="å¼€å§‹åˆ†æ">å¼€å§‹åˆ†æ</h3>
<p>æ¼æ´ä½ç½®ï¼š</p>
<blockquote>
<p>In <code>u-boot/net/net.c</code> the <code>__net_defragment</code> function line 900 through 1018.</p>
</blockquote>
<p>æ¼æ´æºç ï¼š</p>
<p><a class="link" href="https://elixir.bootlin.com/u-boot/v2022.04/source/net/net.c#L900"  target="_blank" rel="noopener"
    >https://elixir.bootlin.com/u-boot/v2022.04/source/net/net.c#L900</a></p>
<p>defragmentå³reassemblyçš„æ“ä½œï¼Œåˆå¹¶åˆ†ç‰‡ã€‚æ³¨é‡Šä¸åˆ†æå¦‚ä¸‹ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">static</span> <span class="k">struct</span> <span class="n">ip_udp_hdr</span> <span class="o">*</span><span class="nf">__net_defragment</span><span class="p">(</span><span class="k">struct</span> <span class="n">ip_udp_hdr</span> <span class="o">*</span><span class="n">ip</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">lenp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">static</span> <span class="n">uchar</span> <span class="n">pkt_buff</span><span class="p">[</span><span class="n">IP_PKTSIZE</span><span class="p">]</span> <span class="n">__aligned</span><span class="p">(</span><span class="n">PKTALIGN</span><span class="p">);</span> <span class="c1">// packet_buffer ip_packet_size packet_align
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">static</span> <span class="n">u16</span> <span class="n">first_hole</span><span class="p">,</span> <span class="n">total_len</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">struct</span> <span class="n">hole</span> <span class="o">*</span><span class="n">payload</span><span class="p">,</span> <span class="o">*</span><span class="n">thisfrag</span><span class="p">,</span> <span class="o">*</span><span class="n">h</span><span class="p">,</span> <span class="o">*</span><span class="n">newh</span><span class="p">;</span> <span class="c1">// payload this_fragment hole new_hole
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">struct</span> <span class="n">ip_udp_hdr</span> <span class="o">*</span><span class="n">localip</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ip_udp_hdr</span> <span class="o">*</span><span class="p">)</span><span class="n">pkt_buff</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">uchar</span> <span class="o">*</span><span class="n">indata</span> <span class="o">=</span> <span class="p">(</span><span class="n">uchar</span> <span class="o">*</span><span class="p">)</span><span class="n">ip</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="n">offset8</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">done</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">u16</span> <span class="n">ip_off</span> <span class="o">=</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">ip_off</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="cm">/* payload starts after IP header, this fragment is in there */</span>
</span></span><span class="line"><span class="cl">	<span class="n">payload</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">hole</span> <span class="o">*</span><span class="p">)(</span><span class="n">pkt_buff</span> <span class="o">+</span> <span class="n">IP_HDR_SIZE</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">offset8</span> <span class="o">=</span>  <span class="p">(</span><span class="n">ip_off</span> <span class="o">&amp;</span> <span class="n">IP_OFFS</span><span class="p">);</span> <span class="c1">// IP_OFFS 0x1fff 0b0001111111111111ï¼Œåˆ†ç‰‡ç´¢å¼•çš„åŸºæœ¬å•ä½ä¸º8å­—èŠ‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">thisfrag</span> <span class="o">=</span> <span class="n">payload</span> <span class="o">+</span> <span class="n">offset8</span><span class="p">;</span> <span class="c1">// å½“å‰åˆ†ç‰‡çš„ç´¢å¼•ï¼ˆ8å­—èŠ‚ï¼‰
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">start</span> <span class="o">=</span> <span class="n">offset8</span> <span class="o">*</span> <span class="mi">8</span><span class="p">;</span> <span class="c1">// å½“å‰åˆ†ç‰‡çš„å­—èŠ‚ç´¢å¼•
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">len</span> <span class="o">=</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">ip_len</span><span class="p">)</span> <span class="o">-</span> <span class="n">IP_HDR_SIZE</span><span class="p">;</span> <span class="c1">// æ”»å‡»è€…é€šè¿‡æ„é€ æ¶æ„æ•°æ®åŒ…ï¼Œå°†ip-&gt;ip_lenæ§åˆ¶åœ¨21~27ï¼Œä½¿å¾—lenä¸º1~7çš„å€¼ï¼Œè§¦å‘åç»­æ¼æ´
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">start</span> <span class="o">+</span> <span class="n">len</span> <span class="o">&gt;</span> <span class="n">IP_MAXUDP</span><span class="p">)</span> <span class="cm">/* fragment extends too far */</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">total_len</span> <span class="o">||</span> <span class="n">localip</span><span class="o">-&gt;</span><span class="n">ip_id</span> <span class="o">!=</span> <span class="n">ip</span><span class="o">-&gt;</span><span class="n">ip_id</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// group of fragments of a single IP datagramä¸åŒï¼Œæ„å‘³ç€æ–°æ¥çš„åˆ†ç‰‡ä¸å±äºåŒä¸€æ•°æ®æŠ¥
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="cm">/* new (or different) packet, reset structs */</span>
</span></span><span class="line"><span class="cl">		<span class="n">total_len</span> <span class="o">=</span> <span class="mh">0xffff</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">payload</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">last_byte</span> <span class="o">=</span> <span class="o">~</span><span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">payload</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">next_hole</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">payload</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">prev_hole</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">first_hole</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="cm">/* any IP header will work, copy the first we received */</span>
</span></span><span class="line"><span class="cl">		<span class="n">memcpy</span><span class="p">(</span><span class="n">localip</span><span class="p">,</span> <span class="n">ip</span><span class="p">,</span> <span class="n">IP_HDR_SIZE</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// æ­¤åå°±æ˜¯å…·ä½“çš„reassemblyç®—æ³•å®ç°äº†
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">	 * What follows is the reassembly algorithm. We use the payload
</span></span></span><span class="line"><span class="cl"><span class="cm">	 * array as a linked list of hole descriptors, as each hole starts
</span></span></span><span class="line"><span class="cl"><span class="cm">	 * at a multiple of 8 bytes. However, last byte can be whatever value,
</span></span></span><span class="line"><span class="cl"><span class="cm">	 * so it is represented as byte count, not as 8-byte blocks.
</span></span></span><span class="line"><span class="cl"><span class="cm">	 */</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">h</span> <span class="o">=</span> <span class="n">payload</span> <span class="o">+</span> <span class="n">first_hole</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">while</span> <span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">last_byte</span> <span class="o">&lt;</span> <span class="n">start</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">next_hole</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="cm">/* no hole that far away */</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="n">h</span> <span class="o">=</span> <span class="n">payload</span> <span class="o">+</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">next_hole</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="cm">/* last fragment may be 1..7 bytes, the &#34;+7&#34; forces acceptance */</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">offset8</span> <span class="o">+</span> <span class="p">((</span><span class="n">len</span> <span class="o">+</span> <span class="mi">7</span><span class="p">)</span> <span class="o">/</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">h</span> <span class="o">-</span> <span class="n">payload</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="cm">/* no overlap with holes (dup fragment?) */</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ip_off</span> <span class="o">&amp;</span> <span class="n">IP_FLAGS_MFRAG</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="cm">/* no more fragmentss: truncate this (last) hole */</span>
</span></span><span class="line"><span class="cl">		<span class="n">total_len</span> <span class="o">=</span> <span class="n">start</span> <span class="o">+</span> <span class="n">len</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">h</span><span class="o">-&gt;</span><span class="n">last_byte</span> <span class="o">=</span> <span class="n">start</span> <span class="o">+</span> <span class="n">len</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">	 * There is some overlap: fix the hole list. This code doesn&#39;t
</span></span></span><span class="line"><span class="cl"><span class="cm">	 * deal with a fragment that overlaps with two different holes
</span></span></span><span class="line"><span class="cl"><span class="cm">	 * (thus being a superset of a previously-received fragment).
</span></span></span><span class="line"><span class="cl"><span class="cm">	 */</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">((</span><span class="n">h</span> <span class="o">&gt;=</span> <span class="n">thisfrag</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">last_byte</span> <span class="o">&lt;=</span> <span class="n">start</span> <span class="o">+</span> <span class="n">len</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="cm">/* complete overlap with hole: remove hole */</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">prev_hole</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">next_hole</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="cm">/* last remaining hole */</span>
</span></span><span class="line"><span class="cl">			<span class="n">done</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">prev_hole</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="cm">/* first hole */</span>
</span></span><span class="line"><span class="cl">			<span class="n">first_hole</span> <span class="o">=</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">next_hole</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">			<span class="n">payload</span><span class="p">[</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">next_hole</span><span class="p">].</span><span class="n">prev_hole</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">next_hole</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="cm">/* last hole */</span>
</span></span><span class="line"><span class="cl">			<span class="n">payload</span><span class="p">[</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">prev_hole</span><span class="p">].</span><span class="n">next_hole</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="cm">/* in the middle of the list */</span>
</span></span><span class="line"><span class="cl">			<span class="n">payload</span><span class="p">[</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">next_hole</span><span class="p">].</span><span class="n">prev_hole</span> <span class="o">=</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">prev_hole</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">			<span class="n">payload</span><span class="p">[</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">prev_hole</span><span class="p">].</span><span class="n">next_hole</span> <span class="o">=</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">next_hole</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">last_byte</span> <span class="o">&lt;=</span> <span class="n">start</span> <span class="o">+</span> <span class="n">len</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="cm">/* overlaps with final part of the hole: shorten this hole */</span>
</span></span><span class="line"><span class="cl">		<span class="n">h</span><span class="o">-&gt;</span><span class="n">last_byte</span> <span class="o">=</span> <span class="n">start</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">h</span> <span class="o">&gt;=</span> <span class="n">thisfrag</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="cm">/* overlaps with initial part of the hole: move this hole */</span>
</span></span><span class="line"><span class="cl">		<span class="n">newh</span> <span class="o">=</span> <span class="n">thisfrag</span> <span class="o">+</span> <span class="p">(</span><span class="n">len</span> <span class="o">/</span> <span class="mi">8</span><span class="p">);</span> <span class="c1">// è®¡ç®—new_holeçš„åˆ†ç‰‡ç´¢å¼•å€¼ã€‚lenä¸º1~7çš„å€¼æ—¶ï¼Œä¼šå¯¼è‡´æ­¤å¤„ newh == thisfrag
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="o">*</span><span class="n">newh</span> <span class="o">=</span> <span class="o">*</span><span class="n">h</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">h</span> <span class="o">=</span> <span class="n">newh</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">next_hole</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="n">payload</span><span class="p">[</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">next_hole</span><span class="p">].</span><span class="n">prev_hole</span> <span class="o">=</span> <span class="p">(</span><span class="n">h</span> <span class="o">-</span> <span class="n">payload</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">prev_hole</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="n">payload</span><span class="p">[</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">prev_hole</span><span class="p">].</span><span class="n">next_hole</span> <span class="o">=</span> <span class="p">(</span><span class="n">h</span> <span class="o">-</span> <span class="n">payload</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="k">else</span>
</span></span><span class="line"><span class="cl">			<span class="n">first_hole</span> <span class="o">=</span> <span class="p">(</span><span class="n">h</span> <span class="o">-</span> <span class="n">payload</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="cm">/* fragment sits in the middle: split the hole */</span>
</span></span><span class="line"><span class="cl">		<span class="n">newh</span> <span class="o">=</span> <span class="n">thisfrag</span> <span class="o">+</span> <span class="p">(</span><span class="n">len</span> <span class="o">/</span> <span class="mi">8</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="o">*</span><span class="n">newh</span> <span class="o">=</span> <span class="o">*</span><span class="n">h</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">h</span><span class="o">-&gt;</span><span class="n">last_byte</span> <span class="o">=</span> <span class="n">start</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">h</span><span class="o">-&gt;</span><span class="n">next_hole</span> <span class="o">=</span> <span class="p">(</span><span class="n">newh</span> <span class="o">-</span> <span class="n">payload</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">newh</span><span class="o">-&gt;</span><span class="n">prev_hole</span> <span class="o">=</span> <span class="p">(</span><span class="n">h</span> <span class="o">-</span> <span class="n">payload</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="n">newh</span><span class="o">-&gt;</span><span class="n">next_hole</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="n">payload</span><span class="p">[</span><span class="n">newh</span><span class="o">-&gt;</span><span class="n">next_hole</span><span class="p">].</span><span class="n">prev_hole</span> <span class="o">=</span> <span class="p">(</span><span class="n">newh</span> <span class="o">-</span> <span class="n">payload</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="cm">/* finally copy this fragment and possibly return whole packet */</span>
</span></span><span class="line"><span class="cl">	<span class="n">memcpy</span><span class="p">((</span><span class="n">uchar</span> <span class="o">*</span><span class="p">)</span><span class="n">thisfrag</span><span class="p">,</span> <span class="n">indata</span> <span class="o">+</span> <span class="n">IP_HDR_SIZE</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span> <span class="cm">/* è¿™é‡Œå‘this_fragmentä¸­å†™å…¥æ”»å‡»è€…å¯æ§çš„æ•°æ®ï¼Œ
</span></span></span><span class="line"><span class="cl"><span class="cm">							ä½†ç”±äº newh == thisfragï¼Œé€ æˆnew_holeä¸­çš„æ§åˆ¶æ•°æ®è¢«ç¯¡æ”¹ï¼ˆç±»ä¼¼äºfree chunk headerè¢«ç¯¡æ”¹ï¼‰ã€‚
</span></span></span><span class="line"><span class="cl"><span class="cm">							ä¸”å½“lenä¸º6æ—¶ï¼Œfirst_holeä¸­çš„last_byteã€next_holeã€prev_holeéƒ½è¢«æ”»å‡»è€…æ§åˆ¶ï¼Œ
</span></span></span><span class="line"><span class="cl"><span class="cm">							ç”±æ­¤ï¼Œæ”»å‡»è€…é€šè¿‡åŠ«æŒholeçš„ä½ç½®ç´¢å¼•ï¼Œé€ æˆä»»æ„åœ°å€å†™ã€‚*/</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">done</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">localip</span><span class="o">-&gt;</span><span class="n">ip_len</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">total_len</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="o">*</span><span class="n">lenp</span> <span class="o">=</span> <span class="n">total_len</span> <span class="o">+</span> <span class="n">IP_HDR_SIZE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">localip</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>æ‰€ä»¥å®é™…ä¸Šæ˜¯ä¸€ä¸ªï¼šç›²ç›®ä¿¡ä»»ç”¨æˆ·ä¼ å…¥çš„IPæ•°æ®æŠ¥ä¸­çš„<code>ip_len</code>å­—æ®µï¼Œé€ æˆholeç»“æ„è¢«åŠ«æŒï¼Œè€Œå¯¼è‡´çš„æ•°ç»„è¶Šç•Œå†™æ¼æ´ã€‚</p>
<p>ç”±æ­¤è¾¾æˆçš„ä»»æ„åœ°å€å†™å¯ä»¥ç”¨äºrootæœ¬åœ°è®¾å¤‡ã€‚ä½†ç”±äºè·¯ç”±å™¨å¾€å¾€ä¼šå¯¹ç»è¿‡è‡ªå·±çš„æ•°æ®åŒ…åˆæ³•æ€§åšæ ¡éªŒå¹¶ä¸¢å¼ƒéæ³•æ•°æ®æŠ¥ï¼Œå¯¼è‡´æ­¤æ¼æ´éš¾ä»¥äºäº’è”ç½‘ä¸Šåˆ©ç”¨ã€‚</p>
<h2 id="cve-2022-30552">CVE-2022-30552</h2>
<p>æ¼æ´å‡ºç°ä½ç½®å’Œä¸Šä¸ªæ¼æ´ç›¸åŒ</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">static</span> <span class="k">struct</span> <span class="n">ip_udp_hdr</span> <span class="o">*</span><span class="nf">__net_defragment</span><span class="p">(</span><span class="k">struct</span> <span class="n">ip_udp_hdr</span> <span class="o">*</span><span class="n">ip</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">lenp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">static</span> <span class="n">uchar</span> <span class="n">pkt_buff</span><span class="p">[</span><span class="n">IP_PKTSIZE</span><span class="p">]</span> <span class="n">__aligned</span><span class="p">(</span><span class="n">PKTALIGN</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">static</span> <span class="n">u16</span> <span class="n">first_hole</span><span class="p">,</span> <span class="n">total_len</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">struct</span> <span class="n">hole</span> <span class="o">*</span><span class="n">payload</span><span class="p">,</span> <span class="o">*</span><span class="n">thisfrag</span><span class="p">,</span> <span class="o">*</span><span class="n">h</span><span class="p">,</span> <span class="o">*</span><span class="n">newh</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">struct</span> <span class="n">ip_udp_hdr</span> <span class="o">*</span><span class="n">localip</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ip_udp_hdr</span> <span class="o">*</span><span class="p">)</span><span class="n">pkt_buff</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">uchar</span> <span class="o">*</span><span class="n">indata</span> <span class="o">=</span> <span class="p">(</span><span class="n">uchar</span> <span class="o">*</span><span class="p">)</span><span class="n">ip</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="n">offset8</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">done</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">u16</span> <span class="n">ip_off</span> <span class="o">=</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">ip_off</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="cm">/* payload starts after IP header, this fragment is in there */</span>
</span></span><span class="line"><span class="cl">	<span class="n">payload</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">hole</span> <span class="o">*</span><span class="p">)(</span><span class="n">pkt_buff</span> <span class="o">+</span> <span class="n">IP_HDR_SIZE</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">offset8</span> <span class="o">=</span>  <span class="p">(</span><span class="n">ip_off</span> <span class="o">&amp;</span> <span class="n">IP_OFFS</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">thisfrag</span> <span class="o">=</span> <span class="n">payload</span> <span class="o">+</span> <span class="n">offset8</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">start</span> <span class="o">=</span> <span class="n">offset8</span> <span class="o">*</span> <span class="mi">8</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">len</span> <span class="o">=</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">ip</span><span class="o">-&gt;</span><span class="n">ip_len</span><span class="p">)</span> <span class="o">-</span> <span class="n">IP_HDR_SIZE</span><span class="p">;</span> <span class="c1">// ip-&gt;ip_lenç”±æ”»å‡»è€…æ§åˆ¶ï¼Œå°†å…¶è®¾å®šä¸ºå°äºIP_HDR_SIZEçš„å€¼ä¼šä½¿å¾—lenä¸ºè´Ÿå€¼
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">start</span> <span class="o">+</span> <span class="n">len</span> <span class="o">&gt;</span> <span class="n">IP_MAXUDP</span><span class="p">)</span> <span class="cm">/* fragment extends too far */</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">total_len</span> <span class="o">||</span> <span class="n">localip</span><span class="o">-&gt;</span><span class="n">ip_id</span> <span class="o">!=</span> <span class="n">ip</span><span class="o">-&gt;</span><span class="n">ip_id</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="cm">/* new (or different) packet, reset structs */</span>
</span></span><span class="line"><span class="cl">		<span class="n">total_len</span> <span class="o">=</span> <span class="mh">0xffff</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">payload</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">last_byte</span> <span class="o">=</span> <span class="o">~</span><span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">payload</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">next_hole</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">payload</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">prev_hole</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">first_hole</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="cm">/* any IP header will work, copy the first we received */</span>
</span></span><span class="line"><span class="cl">		<span class="n">memcpy</span><span class="p">(</span><span class="n">localip</span><span class="p">,</span> <span class="n">ip</span><span class="p">,</span> <span class="n">IP_HDR_SIZE</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">	 * What follows is the reassembly algorithm. We use the payload
</span></span></span><span class="line"><span class="cl"><span class="cm">	 * array as a linked list of hole descriptors, as each hole starts
</span></span></span><span class="line"><span class="cl"><span class="cm">	 * at a multiple of 8 bytes. However, last byte can be whatever value,
</span></span></span><span class="line"><span class="cl"><span class="cm">	 * so it is represented as byte count, not as 8-byte blocks.
</span></span></span><span class="line"><span class="cl"><span class="cm">	 */</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">h</span> <span class="o">=</span> <span class="n">payload</span> <span class="o">+</span> <span class="n">first_hole</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">while</span> <span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">last_byte</span> <span class="o">&lt;</span> <span class="n">start</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">next_hole</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="cm">/* no hole that far away */</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="n">h</span> <span class="o">=</span> <span class="n">payload</span> <span class="o">+</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">next_hole</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="cm">/* last fragment may be 1..7 bytes, the &#34;+7&#34; forces acceptance */</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">offset8</span> <span class="o">+</span> <span class="p">((</span><span class="n">len</span> <span class="o">+</span> <span class="mi">7</span><span class="p">)</span> <span class="o">/</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">h</span> <span class="o">-</span> <span class="n">payload</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="cm">/* no overlap with holes (dup fragment?) */</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ip_off</span> <span class="o">&amp;</span> <span class="n">IP_FLAGS_MFRAG</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="cm">/* no more fragmentss: truncate this (last) hole */</span>
</span></span><span class="line"><span class="cl">		<span class="n">total_len</span> <span class="o">=</span> <span class="n">start</span> <span class="o">+</span> <span class="n">len</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">h</span><span class="o">-&gt;</span><span class="n">last_byte</span> <span class="o">=</span> <span class="n">start</span> <span class="o">+</span> <span class="n">len</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">	 * There is some overlap: fix the hole list. This code doesn&#39;t
</span></span></span><span class="line"><span class="cl"><span class="cm">	 * deal with a fragment that overlaps with two different holes
</span></span></span><span class="line"><span class="cl"><span class="cm">	 * (thus being a superset of a previously-received fragment).
</span></span></span><span class="line"><span class="cl"><span class="cm">	 */</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">((</span><span class="n">h</span> <span class="o">&gt;=</span> <span class="n">thisfrag</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">last_byte</span> <span class="o">&lt;=</span> <span class="n">start</span> <span class="o">+</span> <span class="n">len</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="cm">/* complete overlap with hole: remove hole */</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">prev_hole</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">next_hole</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="cm">/* last remaining hole */</span>
</span></span><span class="line"><span class="cl">			<span class="n">done</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">prev_hole</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="cm">/* first hole */</span>
</span></span><span class="line"><span class="cl">			<span class="n">first_hole</span> <span class="o">=</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">next_hole</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">			<span class="n">payload</span><span class="p">[</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">next_hole</span><span class="p">].</span><span class="n">prev_hole</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">next_hole</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="cm">/* last hole */</span>
</span></span><span class="line"><span class="cl">			<span class="n">payload</span><span class="p">[</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">prev_hole</span><span class="p">].</span><span class="n">next_hole</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="cm">/* in the middle of the list */</span>
</span></span><span class="line"><span class="cl">			<span class="n">payload</span><span class="p">[</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">next_hole</span><span class="p">].</span><span class="n">prev_hole</span> <span class="o">=</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">prev_hole</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">			<span class="n">payload</span><span class="p">[</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">prev_hole</span><span class="p">].</span><span class="n">next_hole</span> <span class="o">=</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">next_hole</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">last_byte</span> <span class="o">&lt;=</span> <span class="n">start</span> <span class="o">+</span> <span class="n">len</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="cm">/* overlaps with final part of the hole: shorten this hole */</span>
</span></span><span class="line"><span class="cl">		<span class="n">h</span><span class="o">-&gt;</span><span class="n">last_byte</span> <span class="o">=</span> <span class="n">start</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">h</span> <span class="o">&gt;=</span> <span class="n">thisfrag</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="cm">/* overlaps with initial part of the hole: move this hole */</span>
</span></span><span class="line"><span class="cl">		<span class="n">newh</span> <span class="o">=</span> <span class="n">thisfrag</span> <span class="o">+</span> <span class="p">(</span><span class="n">len</span> <span class="o">/</span> <span class="mi">8</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="o">*</span><span class="n">newh</span> <span class="o">=</span> <span class="o">*</span><span class="n">h</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">h</span> <span class="o">=</span> <span class="n">newh</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">next_hole</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="n">payload</span><span class="p">[</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">next_hole</span><span class="p">].</span><span class="n">prev_hole</span> <span class="o">=</span> <span class="p">(</span><span class="n">h</span> <span class="o">-</span> <span class="n">payload</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">prev_hole</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="n">payload</span><span class="p">[</span><span class="n">h</span><span class="o">-&gt;</span><span class="n">prev_hole</span><span class="p">].</span><span class="n">next_hole</span> <span class="o">=</span> <span class="p">(</span><span class="n">h</span> <span class="o">-</span> <span class="n">payload</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="k">else</span>
</span></span><span class="line"><span class="cl">			<span class="n">first_hole</span> <span class="o">=</span> <span class="p">(</span><span class="n">h</span> <span class="o">-</span> <span class="n">payload</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="cm">/* fragment sits in the middle: split the hole */</span>
</span></span><span class="line"><span class="cl">		<span class="n">newh</span> <span class="o">=</span> <span class="n">thisfrag</span> <span class="o">+</span> <span class="p">(</span><span class="n">len</span> <span class="o">/</span> <span class="mi">8</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="o">*</span><span class="n">newh</span> <span class="o">=</span> <span class="o">*</span><span class="n">h</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">h</span><span class="o">-&gt;</span><span class="n">last_byte</span> <span class="o">=</span> <span class="n">start</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">h</span><span class="o">-&gt;</span><span class="n">next_hole</span> <span class="o">=</span> <span class="p">(</span><span class="n">newh</span> <span class="o">-</span> <span class="n">payload</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">newh</span><span class="o">-&gt;</span><span class="n">prev_hole</span> <span class="o">=</span> <span class="p">(</span><span class="n">h</span> <span class="o">-</span> <span class="n">payload</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="n">newh</span><span class="o">-&gt;</span><span class="n">next_hole</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="n">payload</span><span class="p">[</span><span class="n">newh</span><span class="o">-&gt;</span><span class="n">next_hole</span><span class="p">].</span><span class="n">prev_hole</span> <span class="o">=</span> <span class="p">(</span><span class="n">newh</span> <span class="o">-</span> <span class="n">payload</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="cm">/* finally copy this fragment and possibly return whole packet */</span>
</span></span><span class="line"><span class="cl">	<span class="n">memcpy</span><span class="p">((</span><span class="n">uchar</span> <span class="o">*</span><span class="p">)</span><span class="n">thisfrag</span><span class="p">,</span> <span class="n">indata</span> <span class="o">+</span> <span class="n">IP_HDR_SIZE</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span> <span class="c1">// ç”±äºlenä¸ºè´Ÿå€¼ï¼Œæ­¤å¤„å‘ç”Ÿæ•´æ•°æº¢å‡ºï¼Œmemcpyé€ æˆæ ˆæº¢å‡º
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">done</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">localip</span><span class="o">-&gt;</span><span class="n">ip_len</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">total_len</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="o">*</span><span class="n">lenp</span> <span class="o">=</span> <span class="n">total_len</span> <span class="o">+</span> <span class="n">IP_HDR_SIZE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">localip</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>åŒæ ·æ˜¯å› ä¸ºç›²ä¿¡æ”»å‡»è€…çš„IPæ•°æ®æŠ¥è€Œæœªåšæ ¡éªŒï¼Œé€ æˆçš„æ•´æ•°æº¢å‡ºä¸æ ˆæº¢å‡ºæ¼æ´ã€‚</p>
<h1 id="æ¼æ´å½±å“">æ¼æ´å½±å“</h1>
<p>ç”±gitä»“åº“æŸ¥çœ‹ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">git clone https://github.com/u-boot/u-boot.git
</span></span><span class="line"><span class="cl"><span class="nb">cd</span> u-boot
</span></span><span class="line"><span class="cl">git log net/net.c
</span></span></code></pre></td></tr></table>
</div>
</div><p>å¯ä»¥çœ‹åˆ°ä¿®å¤çš„commitï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">commit b85d130ea0cac152c21ec38ac9417b31d41b5552
</span></span><span class="line"><span class="cl">Author: Fabio Estevam &lt;festevam@denx.de&gt;
</span></span><span class="line"><span class="cl">Date:   Thu May <span class="m">26</span> 11:14:37 <span class="m">2022</span> -0300
</span></span></code></pre></td></tr></table>
</div>
</div><p>ç”±æ­¤æ‰¾åˆ°äº†æ¼æ´çš„æœ€æ™šå½±å“ç‰ˆæœ¬ï¼Œé‚£ä¹ˆæœ€æ—©æ˜¯ä»€ä¹ˆæ—¶å€™è¢«å¼•å…¥çš„å‘¢ï¼Ÿ</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">git log --follow -p net/net.c
</span></span></code></pre></td></tr></table>
</div>
</div><p>ä¸€ç›´å‘å‰å›æº¯<code>__net_defragment</code>çš„å†å²ï¼Œèƒ½æ‰¾åˆ°æœ€æ—©å¼•å…¥è¯¥å‡½æ•°çš„commitï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">commit 5cfaa4e54d0eb8232fa1cf092d955fdaed5b673d
</span></span><span class="line"><span class="cl">Author: Alessandro Rubini &lt;rubini-list@gnudd.com&gt;
</span></span><span class="line"><span class="cl">Date:   Fri Aug <span class="m">7</span> 13:58:56 <span class="m">2009</span> +0200
</span></span></code></pre></td></tr></table>
</div>
</div><p>æ‰€ä»¥è¿™ä¸¤ä¸ªæ¼æ´å½±å“äº†2009/8/7ï½2022/5/26é—´å¼€å¯äº†<code>CONFIG_IP_DEFRAG</code>ç¼–è¯‘é€‰é¡¹çš„U-Bootã€‚</p>
<h1 id="æ¼æ´ä¿®å¤">æ¼æ´ä¿®å¤</h1>
<p>æŸ¥çœ‹ä¿®å¤çš„patchï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">git diff b85d130~ b85d13
</span></span></code></pre></td></tr></table>
</div>
</div><p>å¾—åˆ°ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-diff" data-lang="diff"><span class="line"><span class="cl"><span class="gh">diff --git a/include/net.h b/include/net.h
</span></span></span><span class="line"><span class="cl"><span class="gh">index 675bf4171b..e3889a0bc8 100644
</span></span></span><span class="line"><span class="cl"><span class="gh"></span><span class="gd">--- a/include/net.h
</span></span></span><span class="line"><span class="cl"><span class="gd"></span><span class="gi">+++ b/include/net.h
</span></span></span><span class="line"><span class="cl"><span class="gi"></span><span class="gu">@@ -391,6 +391,8 @@ struct ip_hdr {
</span></span></span><span class="line"><span class="cl"><span class="gu"></span>
</span></span><span class="line"><span class="cl"> #define IP_HDR_SIZE            (sizeof(struct ip_hdr))
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="gi">+#define IP_MIN_FRAG_DATAGRAM_SIZE      (IP_HDR_SIZE + 8)
</span></span></span><span class="line"><span class="cl"><span class="gi">+
</span></span></span><span class="line"><span class="cl"><span class="gi"></span> /*
</span></span><span class="line"><span class="cl">  *     Internet Protocol (IP) + UDP header.
</span></span><span class="line"><span class="cl">  */
</span></span><span class="line"><span class="cl"><span class="gh">diff --git a/net/net.c b/net/net.c
</span></span></span><span class="line"><span class="cl"><span class="gh">index 034a5d6e67..81905f6315 100644
</span></span></span><span class="line"><span class="cl"><span class="gh"></span><span class="gd">--- a/net/net.c
</span></span></span><span class="line"><span class="cl"><span class="gd"></span><span class="gi">+++ b/net/net.c
</span></span></span><span class="line"><span class="cl"><span class="gi"></span><span class="gu">@@ -907,6 +907,9 @@ static struct ip_udp_hdr *__net_defragment(struct ip_udp_hdr *ip, int *lenp)
</span></span></span><span class="line"><span class="cl"><span class="gu"></span>        int offset8, start, len, done = 0;
</span></span><span class="line"><span class="cl">        u16 ip_off = ntohs(ip-&gt;ip_off);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="gi">+       if (ip-&gt;ip_len &lt; IP_MIN_FRAG_DATAGRAM_SIZE)
</span></span></span><span class="line"><span class="cl"><span class="gi">+               return NULL;
</span></span></span><span class="line"><span class="cl"><span class="gi">+
</span></span></span><span class="line"><span class="cl"><span class="gi"></span>        /* payload starts after IP header, this fragment is in there */
</span></span><span class="line"><span class="cl">        payload = (struct hole *)(pkt_buff + IP_HDR_SIZE);
</span></span><span class="line"><span class="cl">        offset8 =  (ip_off &amp; IP_OFFS);
</span></span></code></pre></td></tr></table>
</div>
</div><p>æ—¢ç„¶ä¸¤ä¸ªæ¼æ´éƒ½æ˜¯ç”±ç›²ä¿¡æ”»å‡»è€…IPæ•°æ®æŠ¥ä¸­çš„ip-&gt;ip_lené€ æˆçš„ï¼Œé‚£ä¹ˆä¿®å¤æ–¹æ¡ˆå°±å¯¹å…¶åšä¸ªæ ¡éªŒå°±å¥½å•¦ã€‚</p>
<p>ä¿®å¤ä»£ç å°±æ˜¯æ·»åŠ é™åˆ¶ï¼š<code>ip-&gt;ip_len &gt;= IP_HDR_SIZE + 8</code></p>

</section>


    <footer class="article-footer">
    
    <section class="article-tags">
        
            <a href="/tags/coreutils/">Coreutils</a>
        
    </section>


    </footer>


    
</article>

    

    

<aside class="related-content--wrapper">
    <h2 class="section-title">Related content</h2>
    <div class="related-content">
        <div class="flex article-list--tile">
            
                
<article class="has-image">
    <a href="/post/cve-2014-0160-%E5%BF%83%E8%84%8F%E6%BB%B4%E8%A1%80%E6%BC%8F%E6%B4%9E%E6%8C%96%E6%8E%98%E4%B8%8E%E5%88%86%E6%9E%90/">
        
        
            <div class="article-image">
                
                    <img src="https://s2.loli.net/2022/05/20/atE5hjX1gbFPnUN.jpg" loading="lazy" data-key="" data-hash="https://s2.loli.net/2022/05/20/atE5hjX1gbFPnUN.jpg"/>
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">CVE-2014-0160 å¿ƒè„æ»´è¡€æ¼æ´æŒ–æ˜ä¸åˆ†æ</h2>
        </div>
    </a>
</article>

            
                
<article class="has-image">
    <a href="/post/cve-2021-3156-sudo-%E6%8F%90%E6%9D%83%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/">
        
        
            <div class="article-image">
                
                    <img src="https://s2.loli.net/2022/05/19/FeqdKtWJZ3GonMX.png" loading="lazy" data-key="" data-hash="https://s2.loli.net/2022/05/19/FeqdKtWJZ3GonMX.png"/>
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">CVE-2021-3156 sudo ææƒæ¼æ´åˆ†æ</h2>
        </div>
    </a>
</article>

            
                
<article class="has-image">
    <a href="/post/cve-2015-5165-qemu%E4%BF%A1%E6%81%AF%E6%B3%84%E9%9C%B2%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/">
        
        
            <div class="article-image">
                
                    <img src="https://s2.loli.net/2022/06/09/jupCyBcahdQEJmP.jpg" loading="lazy" data-key="" data-hash="https://s2.loli.net/2022/06/09/jupCyBcahdQEJmP.jpg"/>
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">CVE-2015-5165 QEMUä¿¡æ¯æ³„éœ²æ¼æ´åˆ†æ</h2>
        </div>
    </a>
</article>

            
                
<article class="has-image">
    <a href="/post/cve-2016-5195-linux-dirtycow%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/">
        
        
            <div class="article-image">
                
                    <img src="https://s2.loli.net/2022/05/24/JFAS5mGpYn9utWi.jpg" loading="lazy" data-key="" data-hash="https://s2.loli.net/2022/05/24/JFAS5mGpYn9utWi.jpg"/>
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">CVE-2016-5195 Linux DirtyCOWæ¼æ´åˆ†æ</h2>
        </div>
    </a>
</article>

            
        </div>
    </div>
</aside>

     
    
        
    

    <footer class="site-footer">
    <section class="copyright">
        &copy; 
        
        2022 Zikey Vi
    </section>
    
    <section class="powerby">
        
            All Rights Abandoned. <br/>
        Built with <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> <br />
        Theme <b><a href="https://github.com/CaiJimmy/hugo-theme-stack" target="_blank" rel="noopener" data-version="3.13.0">Stack</a></b> designed by <a href="https://jimmycai.com" target="_blank" rel="noopener">Jimmy</a>
    </section>
</footer>


    
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    
    <div class="pswp__bg"></div>

    
    <div class="pswp__scroll-wrap">

        
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                
                
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js"integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo="crossorigin="anonymous"
                defer
                >
            </script><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js"integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU="crossorigin="anonymous"
                defer
                >
            </script><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css"crossorigin="anonymous"
            ><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css"crossorigin="anonymous"
            >

            </main>
    <aside class="sidebar right-sidebar sticky">
        
            
                
    <section class="widget archives">
        <div class="widget-icon">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <line x1="5" y1="9" x2="19" y2="9" />
  <line x1="5" y1="15" x2="19" y2="15" />
  <line x1="11" y1="4" x2="7" y2="20" />
  <line x1="17" y1="4" x2="13" y2="20" />
</svg>



        </div>
        <h2 class="widget-title section-title">Table of contents</h2>
        
        <div class="widget--toc">
            <nav id="TableOfContents">
  <ol>
    <li><a href="#u-booté€Ÿè§ˆ">U-Booté€Ÿè§ˆ</a></li>
    <li><a href="#æ‘ä¸­ä¼ è¨€">æ‘ä¸­ä¼ è¨€</a></li>
    <li><a href="#æ¼æ´æºç åˆ†æ">æ¼æ´æºç åˆ†æ</a>
      <ol>
        <li><a href="#cve-2022-30790">CVE-2022-30790</a>
          <ol>
            <li><a href="#rfc815">RFC815</a></li>
            <li><a href="#å¼€å§‹åˆ†æ">å¼€å§‹åˆ†æ</a></li>
          </ol>
        </li>
        <li><a href="#cve-2022-30552">CVE-2022-30552</a></li>
      </ol>
    </li>
    <li><a href="#æ¼æ´å½±å“">æ¼æ´å½±å“</a></li>
    <li><a href="#æ¼æ´ä¿®å¤">æ¼æ´ä¿®å¤</a></li>
  </ol>
</nav>
        </div>
    </section>

            
        
    </aside>


        </div>
        <script 
                src="https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js"integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z&#43;KMkF24hUW8WePSA9HM="crossorigin="anonymous"
                
                >
            </script><script type="text/javascript" src="/ts/main.js" defer></script>
<script>
    (function () {
        const customFont = document.createElement('link');
        customFont.href = "https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap";

        customFont.type = "text/css";
        customFont.rel = "stylesheet";

        document.head.appendChild(customFont);
    }());
</script>

    </body>
</html>
